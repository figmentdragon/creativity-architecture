async = require 'async'
j3 = require 'j3'

class AssignmentUnique
  constructor : (options) ->
    @_resourceType = options.resourceType
    @clear()

  clear : ->
    @_assignmentArray = []
    @_assignmentMap = {}

  addAssignments : (assignments, isInherit) ->
    for eachAssignment in assignments
      @addAssignment eachAssignment, isInherit

    return

  addAssignment : (assignment, isInherit) ->
    key = assignment.aseTp + assignment.aseId
    existedAssignment = @_assignmentMap[key]
    if existedAssignment
      if not existedAssignment.isOverride
        existedAssignment.isOverride = true
        existedAssignment.inheritFrom = assignment
    else
      if isInherit
        inheritFrom = j3.clone assignment
        assignment.isInherit = true
        assignment.inheritFrom = inheritFrom

        # 把子资源的权限作为自身的权限
        if assignment.subPerm
          perm = null
          for eachSubPerm in assignment.subPerm
            if eachSubPerm.type is @_resourceType
              assignment.permVal = eachSubPerm.permVal
              assignment.permLvl = eachSubPerm.permLvl

      @_assignmentMap[key] = assignment
      @_assignmentArray.push assignment

    return

  getAssignmentArray : ->
    @_assignmentArray

module.exports = AssignmentUnique
